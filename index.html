<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>D&D 5e explorer</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
    }
    progress {
      width: 100%;
      height: 20px;
    }
    pre {
      max-height: 60vh;
      overflow-y: auto;
      background: #f5f5f5;
      padding: 1em;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 1em;
    }
    .error {
      color: red;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>D&D 5e explorer</h1>
  <p id="status">Initialisiere...</p>
  <progress id="progress" value="0" max="100"></progress>
  <pre id="output">Warte auf Start...</pre>
  <div id="errors" class="error"></div>
  <button onclick="refreshData()">Daten neu laden</button>

  <script>
    const baseUrl = "https://www.dnd5eapi.co";
    const dbName = "dnd5e-indexeddb";
    const statusEl = document.getElementById("status");
    const progressEl = document.getElementById("progress");
    const outputEl = document.getElementById("output");
    const errorEl = document.getElementById("errors");

    function logError(message, error) {
      const fullMessage = `${message}: ${error.message || error}`;
      console.error(fullMessage);
      errorEl.textContent += fullMessage + '\n';
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function fetchEndpoints() {
      const api = await fetchJSON(`${baseUrl}/api`);
      return Object.keys(api); // z.B. ["/api/spells", "/api/monsters"]
    }

    function openDB(storeNames) {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(dbName, 1);

        req.onupgradeneeded = (event) => {
          const db = event.target.result;
          for (const storeName of storeNames) {
            if (!db.objectStoreNames.contains(storeName)) {
              db.createObjectStore(storeName, { keyPath: "index" });
            }
          }
        };

        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function storeDetails(storeName, data) {
      return new Promise(async (resolve, reject) => {
        try {
          const db = await openDB([storeName]);
          const tx = db.transaction(storeName, "readwrite");
          const store = tx.objectStore(storeName);
          for (const item of data) {
            store.put(item);
          }
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        } catch (err) {
          reject(err);
        }
      });
    }

    async function loadFromDB(endpoints) {
      const db = await openDB(endpoints.map(e => e.replace("/api/", "")));
      const allData = {};

      for (const path of endpoints) {
        const storeName = path.replace("/api/", "");
        const tx = db.transaction(storeName, "readonly");
        const store = tx.objectStore(storeName);
        const req = store.getAll();

        const result = await new Promise((res, rej) => {
          req.onsuccess = () => res(req.result);
          req.onerror = () => rej(req.error);
        });

        allData[storeName] = result;
      }

      statusEl.textContent = "Daten aus IndexedDB geladen.";
      progressEl.value = progressEl.max;
      outputEl.textContent = JSON.stringify(allData, null, 2);
      return true;
    }

    async function fetchAll() {
      try {
        const endpoints = await fetchEndpoints();
        progressEl.max = endpoints.length;
        progressEl.value = 0;

        for (let i = 0; i < endpoints.length; i++) {
          const endpointPath = endpoints[i];
          const storeName = endpointPath.replace("/api/", "");
          statusEl.textContent = `Lade ${storeName}...`;

          try {
            const list = await fetchJSON(baseUrl + endpointPath);

            const items = list.results || [];
            const detailed = [];

            for (let j = 0; j < items.length; j++) {
              const item = items[j];
              statusEl.textContent = `Lade ${storeName} (${j + 1}/${items.length})`;
              try {
                const detail = await fetchJSON(baseUrl + item.url);
                detailed.push(detail);
              } catch (err) {
                logError(`Fehler beim Laden von ${item.url}`, err);
              }
            }

            await storeDetails(storeName, detailed);
          } catch (err) {
            logError(`Load failed: ${storeName}`, err);
          }

          progressEl.value = i + 1;
        }

        statusEl.textContent = "Fertig! Daten geladen.";
        await loadFromDB(endpoints);
      } catch (err) {
        logError("Fehler beim Initialisieren", err);
      }
    }

    function refreshData() {
      const confirmed = confirm("Willst du die gespeicherten Daten wirklich löschen und neu laden?");
      if (confirmed) {
        const req = indexedDB.deleteDatabase(dbName);
        req.onsuccess = () => location.reload();
        req.onerror = () => logError("Fehler beim Löschen der Datenbank", req.error);
      }
    }

    // Start
    fetchEndpoints()
      .then(async endpoints => {
        try {
          const success = await loadFromDB(endpoints);
          if (!success) await fetchAll();
        } catch {
          await fetchAll();
        }
      })
      .catch(err => {
        logError("Fehler beim Abrufen der Endpunkte", err);
      });
  </script>
</body>
</html>